WAF 머신러닝 탐지 시스템 동작 방식 공유

  1. 어떤 시스템인가요? (개요)

  저희 시스템은 기본적으로 '비지도 학습' 기반의 '이상 탐지' 
  시스템입니다.

  기존의 룰 기반 탐지 방식이 놓칠 수 있는 알려지지 않은 신규
  공격이나, 정상 요청처럼 보이지만 실제로는 비정상적인 행위를        
  탐지하는 것을 주된 목표로 합니다. 이를 위해 '정상 트래픽'의        
  패턴을 먼저 학습한 뒤, 그 기준에서 벗어나는 요청이 들어오면        
  '이상 트래픽'으로 판단하는 방식을 사용합니다.

  특히, 저희는 탐지율과 안정성을 높이기 위해 Isolation 
  Forest와 Local Outlier Factor라는 두 가지 다른 모델을 함께
  사용하는 앙상블(Ensemble) 방식을 채택

  2. 탐지 과정은 어떻게 되나요? (워크플로우)

  1단계: 요청 분석 및 특징 추출 (피처 엔지니어링)

  단순한 웹 요청은 모델이 바로 이해할 수 없기 때문에, 먼저
  요청 데이터를 분석해서 모델이 학습할 수 있는 13개의 주요
  숫자 특징(피처)으로 변환합니다. 이 과정이 탐지 성능에 가장
  큰 영향을 미칩니다.

   * 경로(Path) 특징 (4개):
       * path_depth: 경로가 얼마나 깊은지 (e.g., /a/b/c -> 3)        
       * path_token_count: 경로가 몇 개의 요소로 이루어져 있는지     
       * path_token_numeric_ratio: 경로에 숫자가 포함된 비율
         (e.g., /users/123/orders -> 0.33)
       * uri_entropy: 경로 문자열의 복잡도. 무작위 문자열 스캔       
         공격 등을 탐지하는 데 효과적입니다.
   * 헤더(Header) 특징 (4개):
       * auth_validity: Authorization 헤더의 유효성 (없음: 0,        
         유효: 1, 형식 오류: -1)
       * referer_domain: 어떤 사이트를 통해 우리 서비스로
         유입되었는지
       * method: GET, POST 같은 요청 메소드
       * accept_type: 요청이 원하는 콘텐츠의 주된 타입을
         나타냅니다. (e.g., text/html). 세상의 모든 Accept
         타입을 학습시킬 수는 없기 때문에, 헤더의 가장 핵심적인      
         첫 부분만 추출해서 '웹페이지 요청', 'API 데이터
         요청'처럼 일반화하여 판단합니다.
   * 상태(Stateful) 기반 특징 (5개):
       * cookie_count: 요청에 포함된 쿠키의 개수
       * req_count: 해당 IP가 최근 60초 동안 보낸 총 요청 수
       * interval: 해당 IP의 바로 직전 요청과의 시간 간격
       * req_count_in_last_10s: 최근 10초간 요청 수 (DDoS 같은       
         대량 요청 탐지)
       * unique_paths_in_last_60s: 최근 60초간 접근한 고유
         경로의 수 (경로 스캔 공격 탐지)

  2단계: 데이터 정규화 (전처리)

  피처마다 값의 범위(스케일)가 다르기 때문에, StandardScaler를
  이용해 모든 피처의 단위를 표준화해주는 정규화 과정을
  거칩니다. 

  3단계: 2개 모델로 동시 예측

  정규화된 데이터는 아래의 두 가지 모델에 각각 전달되어 이상
  여부를 동시에 판단하게 됩니다.

   1. Isolation Forest (`model.pkl`): 데이터를 무작위로 잘라보는
      '숲'을 만들어, 다른 데이터들과 잘 섞이지 않고 외톨이가 되는
      데이터를 이상치로 판단합니다. 구조적으로 특이한 데이터를 잘
      찾아냅니다.
   2. Local Outlier Factor (`lof_model.pkl`): 특정 데이터가 주변
      데이터들과 얼마나 떨어져 있는지 '밀도'를 기반으로
      판단합니다. 주변과 동떨어진 패턴을 보이는 데이터를 잘
      찾아냅니다.

  4단계: 최종 결정

  마지막으로 두 모델의 예측 결과를 종합해서 최종 결정을
  내립니다. 저희는 두 모델 중 하나라도 '이상'이라고 판단하면
  최종적으로 '탐지'로 결론 내리는 방식을 사용합니다.
